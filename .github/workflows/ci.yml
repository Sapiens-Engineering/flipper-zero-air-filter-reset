name: CI

on:
  push:
    branches: [main, master]
    tags:
      - "v*"
  pull_request:
    branches: [main, master]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  fmt:
    name: Format Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: nightly-2025-08-31
          components: rustfmt
      - name: Check formatting
        run: cargo fmt -- --check

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: nightly-2025-08-31
          components: clippy
          targets: thumbv7em-none-eabihf
      - uses: Swatinem/rust-cache@v2
      - name: Clippy
        run: cargo clippy -- --deny warnings

  audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: nightly-2025-08-31
      - name: Install cargo-audit
        run: cargo install cargo-audit --locked
      - name: Run security audit
        run: cargo audit

  build:
    name: Build FAP
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: nightly-2025-08-31
          targets: thumbv7em-none-eabihf
      - name: Build
        run: cargo build --release
        env:
          CARGO_INCREMENTAL: 0
      - name: Archive FAP
        uses: actions/upload-artifact@v4
        with:
          name: fap
          path: target/thumbv7em-none-eabihf/release/flipper-xiaomi-filter-reset.fap

  release:
    name: Create Release
    needs: [fmt, clippy, audit, build]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: nightly-2025-08-31
          targets: thumbv7em-none-eabihf
      - name: Build
        run: cargo build --release
        env:
          CARGO_INCREMENTAL: 0
      - name: Debug tag info
        run: |
          echo "=== Git version ==="
          git --version
          echo "=== Ref info ==="
          echo "github.ref: ${{ github.ref }}"
          echo "github.ref_name: ${{ github.ref_name }}"
          echo "=== List all tags ==="
          git tag -l
          echo "=== Show refs ==="
          git show-ref --tags || true
          echo "=== Try git tag -l ==="
          git tag -l --format='%(contents)' ${{ github.ref_name }} || true
          echo "=== Try for-each-ref ==="
          git for-each-ref --format='%(contents)' ${{ github.ref }} || true
          echo "=== Try cat-file on ref ==="
          git cat-file -t ${{ github.ref }} || true
          git cat-file -p ${{ github.ref }} || true
      - name: Extract tag message
        id: tag_message
        run: |
          git fetch --tags --force
          TAG_MESSAGE=$(git for-each-ref --format='%(contents)' ${{ github.ref }})
          echo "message<<EOF" >> $GITHUB_OUTPUT
          echo "$TAG_MESSAGE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: target/thumbv7em-none-eabihf/release/flipper-xiaomi-filter-reset.fap
          body: ${{ steps.tag_message.outputs.message }}
          draft: false
          prerelease: false
